/*!
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */(function(a,c,b,d){var g='ontouchstart'in b,e=function(){var a=b.createElement('div'),d=b.documentElement,e;return'pointerEvents'in a.style&&(a.style.pointerEvents='auto',a.style.pointerEvents='x',d.appendChild(a),e=c.getComputedStyle&&c.getComputedStyle(a,'').pointerEvents==='auto',d.removeChild(a),!!e)}(),h={listNodeName:'ol',itemNodeName:'li',rootClass:'dd',listClass:'dd-list',itemClass:'dd-item',dragClass:'dd-dragel',handleClass:'dd-handle',collapsedClass:'dd-collapsed',placeClass:'dd-placeholder',noDragClass:'dd-nodrag',emptyClass:'dd-empty',expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};function f(c,d){this.w=a(b),this.el=a(c),this.options=a.extend({},h,d),this.init()}f.prototype={init:function(){var b=this,e,f,d;b.reset(),b.el.data('nestable-group',this.options.group),b.placeEl=a('<div class="'+b.options.placeClass+'"/>'),a.each(this.el.find(b.options.itemNodeName),function(d,c){b.setParent(a(c))}),b.el.on('click','button',function(f){if(b.dragEl)return;var c=a(f.currentTarget),d=c.data('action'),e=c.parent(b.options.itemNodeName);d==='collapse'&&b.collapseItem(e),d==='expand'&&b.expandItem(e)}),e=function(c){var d=a(c.target);if(!d.hasClass(b.options.handleClass)){if(d.closest('.'+b.options.noDragClass).length)return;d=d.closest('.'+b.options.handleClass)}if(!d.length||b.dragEl)return;if(b.isTouch=/^touch/.test(c.type),b.isTouch&&c.touches.length!==1)return;c.preventDefault(),b.dragStart(c.touches?c.touches[0]:c)},f=function(a){b.dragEl&&(a.preventDefault(),b.dragMove(a.touches?a.touches[0]:a))},d=function(a){b.dragEl&&(a.preventDefault(),b.dragStop(a.touches?a.touches[0]:a))},g&&(b.el[0].addEventListener('touchstart',e,!1),c.addEventListener('touchmove',f,!1),c.addEventListener('touchend',d,!1),c.addEventListener('touchcancel',d,!1)),b.el.on('mousedown',e),b.w.on('mousemove',f),b.w.on('mouseup',d)},serialize:function(){var c,d=0,b=this;return step=function(d,e){var c=[],f=d.children(b.options.itemNodeName);return f.each(function(){var d=a(this),f=a.extend({},d.data()),g=d.children(b.options.listNodeName);g.length&&(f.children=step(g,e+1)),c.push(f)}),c},c=step(b.el.find(b.options.listNodeName).first(),d),c},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(a){a.removeClass(this.options.collapsedClass),a.children('[data-action="expand"]').hide(),a.children('[data-action="collapse"]').show(),a.children(this.options.listNodeName).show()},collapseItem:function(a){var b=a.children(this.options.listNodeName);b.length&&(a.addClass(this.options.collapsedClass),a.children('[data-action="collapse"]').hide(),a.children('[data-action="expand"]').show(),a.children(this.options.listNodeName).hide())},expandAll:function(){var b=this;b.el.find(b.options.itemNodeName).each(function(){b.expandItem(a(this))})},collapseAll:function(){var b=this;b.el.find(b.options.itemNodeName).each(function(){b.collapseItem(a(this))})},setParent:function(b){b.children(this.options.listNodeName).length&&(b.prepend(a(this.options.expandBtnHTML)),b.prepend(a(this.options.collapseBtnHTML))),b.children('[data-action="expand"]').hide()},unsetParent:function(a){a.removeClass(this.options.collapsedClass),a.children('[data-action]').remove(),a.children(this.options.listNodeName).remove()},dragStart:function(c){var e=this.mouse,h=a(c.target),f=h.closest(this.options.itemNodeName),g,i,j;this.placeEl.css('height',f.height()),e.offsetX=c.offsetX!==d?c.offsetX:c.pageX-h.offset().left,e.offsetY=c.offsetY!==d?c.offsetY:c.pageY-h.offset().top,e.startX=e.lastX=c.pageX,e.startY=e.lastY=c.pageY,this.dragRootEl=this.el,this.dragEl=a(b.createElement(this.options.listNodeName)).addClass(this.options.listClass+' '+this.options.dragClass),this.dragEl.css('width',f.width()),f.after(this.placeEl),f[0].parentNode.removeChild(f[0]),f.appendTo(this.dragEl),a(b.body).append(this.dragEl),this.dragEl.css({left:c.pageX-e.offsetX,top:c.pageY-e.offsetY}),j=this.dragEl.find(this.options.itemNodeName);for(g=0;g<j.length;g++)i=a(j[g]).parents(this.options.listNodeName).length,i>this.dragDepth&&(this.dragDepth=i)},dragStop:function(b){var a=this.dragEl.children(this.options.itemNodeName).first();a[0].parentNode.removeChild(a[0]),this.placeEl.replaceWith(a),this.dragEl.remove(),this.el.trigger('change'),this.hasNewRoot&&this.dragRootEl.trigger('change'),this.reset()},dragMove:function(i){var g,j,h,p,k,f=this.options,d=this.mouse,l,m,n,o,q;if(this.dragEl.css({left:i.pageX-d.offsetX,top:i.pageY-d.offsetY}),d.lastX=d.nowX,d.lastY=d.nowY,d.nowX=i.pageX,d.nowY=i.pageY,d.distX=d.nowX-d.lastX,d.distY=d.nowY-d.lastY,d.lastDirX=d.dirX,d.lastDirY=d.dirY,d.dirX=d.distX===0?0:d.distX>0?1:-1,d.dirY=d.distY===0?0:d.distY>0?1:-1,l=Math.abs(d.distX)>Math.abs(d.distY)?1:0,!d.moving){d.dirAx=l,d.moving=!0;return}if(d.dirAx!==l?(d.distAxX=0,d.distAxY=0):(d.distAxX+=Math.abs(d.distX),d.dirX!==0&&d.dirX!==d.lastDirX&&(d.distAxX=0),d.distAxY+=Math.abs(d.distY),d.dirY!==0&&d.dirY!==d.lastDirY&&(d.distAxY=0)),d.dirAx=l,d.dirAx&&d.distAxX>=f.threshold&&(d.distAxX=0,h=this.placeEl.prev(f.itemNodeName),d.distX>0&&h.length&&!h.hasClass(f.collapsedClass)&&(g=h.find(f.listNodeName).last(),k=this.placeEl.parents(f.listNodeName).length,k+this.dragDepth<=f.maxDepth&&(g.length?(g=h.children(f.listNodeName).last(),g.append(this.placeEl)):(g=a('<'+f.listNodeName+'/>').addClass(f.listClass),g.append(this.placeEl),h.append(g),this.setParent(h)))),d.distX<0&&(p=this.placeEl.next(f.itemNodeName),p.length||(j=this.placeEl.parent(),this.placeEl.closest(f.itemNodeName).after(this.placeEl),j.children().length||this.unsetParent(j.parent())))),m=!1,e||(this.dragEl[0].style.visibility='hidden'),this.pointEl=a(b.elementFromPoint(i.pageX-b.body.scrollLeft,i.pageY-(c.pageYOffset||b.documentElement.scrollTop))),e||(this.dragEl[0].style.visibility='visible'),this.pointEl.hasClass(f.handleClass)&&(this.pointEl=this.pointEl.parent(f.itemNodeName)),this.pointEl.hasClass(f.emptyClass))m=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(f.itemClass))return;if(n=this.pointEl.closest('.'+f.rootClass),o=this.dragRootEl.data('nestable-id')!==n.data('nestable-id'),!d.dirAx||o||m){if(o&&f.group!==n.data('nestable-group'))return;if(k=this.dragDepth-1+this.pointEl.parents(f.listNodeName).length,k>f.maxDepth)return;q=i.pageY<this.pointEl.offset().top+this.pointEl.height()/2,j=this.placeEl.parent(),m?(g=a(b.createElement(f.listNodeName)).addClass(f.listClass),g.append(this.placeEl),this.pointEl.replaceWith(g)):q?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),j.children().length||this.unsetParent(j.parent()),this.dragRootEl.find(f.itemNodeName).length||this.dragRootEl.append('<div class="'+f.emptyClass+'"/>'),o&&(this.dragRootEl=n,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},a.fn.nestable=function(b){var c=this,d=this;return c.each(function(){var c=a(this).data("nestable");c?typeof b=='string'&&typeof c[b]=='function'&&(d=c[b]()):(a(this).data("nestable",new f(this,b)),a(this).data("nestable-id",(new Date).getTime()))}),d||c}})(window.jQuery||window.Zepto,window,document)